# DUPR一括更新機能（管理者メニューのエキストラ機能）

DUPR から取得したファイルをアップロードし、会員の DUPR 関連項目を一括で更新する機能。  
エキストラ管理（`/admin/extra`）から「DUPR一括登録ページを開く」で利用する。

## ● 機能概要
- DUPR から取得したファイル（テキスト）をアップロードする。
- ファイル内の **DUPR ID** をキーに、`members` テーブルの該当会員を検索する。
- 該当会員が1件だけ存在する場合、その会員の **DUPR 関連カラム**（`dupr_rate_doubles` / `dupr_rate_singles` / `dupr_rate_date`）を更新する。
- 該当会員が存在しない場合は **スキップ** し、該当会員の情報は変更しない。
- 更新結果（更新済・スキップ・エラー）を画面に件数と行ごとのメッセージで表示する。

## ● ファイル書式
1件あたり6行。レコード間は空行で区切る。

| 行 | 内容 |
|----|------|
| 1 | 氏名 |
| 2 | DUPR ID |
| 3 | 住所 |
| 4 | 年齢・性別（例：`• M` / `51 • F`） |
| 5 | Doubles Rating（数値または `NR`） |
| 6 | Singles Rating（数値または `NR`） |

- `NR` は 0.0 として扱う。

## ● エラー時の挙動
- **同一 DUPR ID が複数会員に登録されている場合**  
  - 該当ユーザーの情報は **更新しない**（更新失敗とする）。  
  - 画面に「エラー」として、理由が分かるメッセージを表示する。  
    - 例：「同一のDUPR IDが複数会員に登録されています。重複を解消してから再度実行してください。」  
  - 重複を解消するまで、その DUPR ID の行は更新されない。
- **該当会員が0件の場合**  
  - 更新は行わず「スキップ」として表示する（例：「該当する会員が存在しません」）。
- **取得・更新処理で DB エラーが発生した場合**  
  - その行は「エラー」とし、エラー内容を表示する。該当会員の情報は変更しない。

---

# 会員の物理削除仕様

## 1. 指定方法
- ニックネームとメールアドレスを入力して削除対象を指定する。

---

## 2. 確認フロー
1. 「削除する」ボタン押下  
2. 以下の確認ダイアログを表示する：  
   ```
   ニックネーム xxx、メールアドレス xxx を物理削除します。よろしいですか？
   ```
3. **キャンセル**  
   - 何もせずエキストラページのまま  
4. **OK**  
   - 削除処理へ進む  

---

## 3. 削除処理

### 3.1 会員取得と一致確認
- `fetchMemberByNicknameAndEmail` で会員を取得  
- メールアドレスが一致しない場合  
  - 「ニックネームとメールアドレスが一致する会員が見つかりません。」を表示  
  - 削除処理は行わない  

### 3.2 参照チェック
- `checkMemberReferenced(memberId)` を実行  
- 参照あり（例：お知らせの author_id）  
  - 警告を表示  
  - 削除しない  

### 3.3 物理削除
- 参照がなければ `deleteMember(member.id)` を実行  
- 削除成功後  
  - 「削除しました。」を表示  
  - 入力フォームをクリア  

---

## 4. 変更したファイル

### ● `src/app/admin/extra/page.tsx`（V3.0.0）
- 一覧表示を廃止  
- 会員ID・メールアドレス入力フォームを追加  
- 「削除する」ボタンを追加  
- 確認ダイアログで OK/キャンセルを分岐  
- `fetchMemberByNicknameAndEmail` で会員を取得  
- メール一致チェック後に参照チェック → 削除  

---

### ● `src/app/admin/extra/page.test.tsx`（V3.0.0）
- ニックネーム・メール入力と削除ボタンが表示されることを検証  
- **キャンセル時**  
  - `fetchMemberByNicknameAndEmail` が呼ばれないこと  
- **OK時**  
  - OK時は ('ヤマダ', 'a@example.com') で呼ばれ削除まで行われることを検証  
  - 「削除しました。」が表示されること  
